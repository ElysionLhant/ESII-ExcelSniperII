# Excel SNIPERII (VSTO 版)

这是一个基于 .NET Framework 4.7.2 开发的 Excel VSTO 加载项（Add-in），深度集成了 LLM（OpenAI、Ollama、LM Studio 等），旨在通过 AI 辅助自动化 Excel 数据处理任务。

## 核心功能

### 1. 智能填充与生成 (Image Mode / Data Write)
- **选区捕获**：一键捕获当前 Excel 选区的截图和坐标信息。
  - **预览功能**：捕获后会出现 "Preview" 按钮，支持查看缩略图和完整图片。
- **多模态上下文**：
  - **一体化输入**：整合式输入框，支持文本输入与文件管理。
  - **剪贴板支持**：支持直接粘贴（Ctrl+V）截图或文件。
  - **文件导入**：支持拖拽文本及图片文件，或通过文件浏览器导入。
- **智能回填**：LLM 生成的结构化数据会自动填充回 Excel 表格。
- **智能表头识别**：自动识别表头行数，保护原有格式或提供上下文。
- **参考现有数据开关 (Reference Existing Data)**：
  - **勾选 (默认)**：发送选区的截图和 CSV 数据给 LLM。适用于 **数据清洗** 和 **修正** 任务，模型需要参考旧数据。
  - **不勾选**：仅发送表头结构（不发截图和数据行）。适用于 **全新数据生成**，避免旧脏数据的干扰。

### 2. 数据操作 (Data Op Mode)
- **模式切换**：通过切换开关在 "Data Write" 和 "Data Op" 模式间切换。
- **VBA 自动生成与执行**：
  - 将选中的数据 (CSV) 和用户 Prompt 发送给 LLM。
  - LLM 自动生成处理该数据的 VBA 代码。
  - 插件自动在后台执行生成的 VBA 代码。
  - 适合复杂的数据清洗、格式调整、计算等任务。
- **注意**：在此模式下，“参考现有数据”开关会自动隐藏，因为 Data Op 模式始终需要数据上下文。

### 3. 全面的设置与管理
- **全新设置窗口**：独立的窗口用于管理所有配置。
- **Prompt 管理**：添加、编辑和删除自定义 Prompt 预设。
- **宏 (Macro) 管理**：管理并持久化常用的 VBA 宏代码。
- **高级 LLM 配置**：
  - **简单模式 (Simple Mode)**：使用全局统一的 LLM 配置。
  - **高级模式 (Advanced Mode)**：为不同任务配置不同的 LLM 提供商/模型：
    - **表头勘测 (Header Detection)**：需要 **多模态** 模型 (具备视觉能力)。
    - **数据写入 (Data Write)**：需要 **多模态** 模型 (具备视觉能力)。
    - **数据操作 (Data Op)**：**纯文本** 模型即可 (代码生成)。
    - **VBA 自愈 (VBA Self-healing)**：**纯文本** 模型即可。
  - **本地模型支持**：内置检测本地 **Ollama** 和 **LM Studio** 实例的功能。
  - **多提供商支持**：OpenAI, Ollama, LM Studio。

### 4. 宏代码库
- **一键运行**：无需打开 VBA 编辑器，直接运行选中的宏。
- **持久化存储**：宏代码库保存在本地。

## 技术栈

- **框架**：.NET Framework 4.7.2, VSTO
- **语言**：C#
- **UI**：WPF (现代化 UI)
- **网络**：HttpClient (TLS 1.2)
- **数据**：JSON 序列化存储

## 如何构建与运行

1. **环境要求**：
   - Windows 操作系统
   - Visual Studio 2019+ (需安装 "Office/SharePoint 开发" 工作负载)
   - Microsoft Excel

2. **打开项目**：
   - 打开 `ExcelSP2/ExcelSP2.sln`。

3. **编译运行**：
   - 按 F5。Visual Studio 会自动编译并启动 Excel。

4. **宏功能配置**：
   - 在 Excel 中：**文件 > 选项 > 信任中心 > 信任中心设置 > 宏设置**。
   - 勾选 **信任对 VBA 工程对象模型的访问**。

## 使用指南

1. **配置设置**：点击 "Settings" 打开配置窗口。
   - 如果运行了 Ollama/LM Studio，可点击 "Detect Local Models"。
   - 选择 "Simple" 或 "Advanced" 模式配置 LLM。
2. **捕获数据**：选中 Excel 数据区域，点击 "Capture"。
3. **选择模式**：
   - **Data Write**：用于填充/清洗单元格。使用 "Reference Existing Data" 复选框控制上下文。
   - **Data Op**：用于通过 VBA 生成进行复杂操作。
4. **添加素材**：拖拽文件或粘贴图片到输入区。
5. **生成**：点击 "Generate & Fill" (或 Data Op 模式下的 "Run")。

## 常见问题

- **API 报错？**：检查设置中的 API Key 和 Base URL。如果使用本地模型，确保服务已启动。
- **宏无法运行？**：请在 Excel 中开启 "信任对 VBA 工程对象模型的访问"。
- **视觉任务失败？**：确保表头检测和数据写入任务使用的是多模态模型（如 gpt-4o, llava）。
