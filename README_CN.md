# Excel SNIPERII (VSTO 版)

这是一个基于 .NET Framework 4.7.2 开发的 Excel VSTO 加载项（Add-in），深度集成了 LLM（OpenAI、火山引擎等），旨在通过 AI 辅助自动化 Excel 数据处理任务。

##  核心功能

### 1. 智能填充与生成
- **选区捕获**：一键捕获当前 Excel 选区的截图和坐标信息。
  - **预览功能**：捕获后会出现 "Preview" 按钮，鼠标悬停可查看缩略图，点击可打开完整图片。
- **多模态上下文**：
  - **一体化输入**：全新的整合式输入框，将文本输入与文件管理有机结合。
  - **剪贴板支持**：支持直接粘贴（Ctrl+V）截图或复制的文件，自动转换为附件。
  - **文件导入**：
    - **拖拽支持**：支持拖拽文本文件（.txt, .csv, .json, .md）及图片文件直接进入输入框。
    - **手动浏览**：提供 "+" 按钮，支持通过文件浏览器批量选择文件导入。
- **智能回填**：LLM 生成的结构化数据会自动填充回 Excel 表格，支持自动扩展行列。
- **表头智能识别与复用**：
  - **首次生成**：自动识别选区内的表头行数，生成内容时自动避开表头区域，保护原有格式。
  - **连续输入**：当在相同列范围内进行后续操作时，插件会复用已识别的表头信息作为上下文，但直接将内容写入当前选定的区域（不再避开表头），实现高效的连续数据录入。
  - **重置功能**：提供重置按钮，可随时清除缓存的表头信息，重新进行表头识别。

### 2. Prompt (提示词) 管理
- **预设库**：内置常用任务 Prompt（如发票提取、数据清洗）。
- **自定义管理**：支持保存、加载和删除自定义 Prompt，配置持久化保存。

### 3. 宏 (Macro) 代码库 
- **VBA 管理**：在侧边栏直接管理常用的 VBA 宏代码。
- **一键运行**：无需打开 VBA 编辑器，直接点击运行即可执行选中的宏。
- **持久化存储**：宏代码库保存在本地，跨工作簿可用。
- *注意：运行宏功能需要在 Excel 信任中心开启信任对 VBA 工程对象模型的访问。*

### 4. 数据模式 (Data Mode)
- **模式切换**：通过界面上的切换开关（Toggle Switch）在 "图像模式" 和 "数据模式" 之间切换。
- **直接数据处理**：无需截图，直接读取当前选中的 Excel 单元格数据（CSV 格式）。
- **VBA 自动生成与执行**：
  - 将选中的数据和用户的 Prompt 发送给 LLM。
  - LLM 自动生成处理该数据的 VBA 代码。
  - 插件自动在后台执行生成的 VBA 代码，直接修改表格内容。
  - 适合复杂的数据清洗、格式调整、计算等任务。

### 5. 系统设置
- **API 配置**：支持自定义 OpenAI 兼容接口（Base URL, API Key, Model Name）。
- **持久化**：所有设置和预设均保存在本地 AppData 目录，重启 Excel 不丢失。

##  技术栈

- **框架**：.NET Framework 4.7.2, VSTO (Visual Studio Tools for Office)
- **语言**：C#
- **UI**：WinForms (使用 FlowLayoutPanel 实现自适应布局)
- **网络**：HttpClient (支持 TLS 1.2)
- **数据**：JSON 序列化存储

##  如何构建与运行

1. **环境要求**：
   - Windows 操作系统
   - Visual Studio 2019 或更高版本（需安装 "Office/SharePoint 开发" 工作负载）
   - Microsoft Excel

2. **打开项目**：
   - 使用 Visual Studio 打开 ExcelSP2/ExcelSP2.sln 解决方案文件。

3. **编译运行**：
   - 点击 Start 或按 F5。
   - Visual Studio 会自动编译并启动 Excel，加载项将出现在侧边栏或功能区中。

4. **宏功能配置**（如果使用宏库）：
   - 在 Excel 中，前往 **文件 > 选项 > 信任中心 > 信任中心设置 > 宏设置**。
   - 勾选 **信任对 VBA 工程对象模型的访问**。

##  使用指南

1. **配置 API**：首次使用请点击侧边栏底部的 " Settings"，填入你的 LLM API 信息。
2. **捕获数据**：选中 Excel 中的数据区域，点击 "Capture Selection"。捕获成功后可通过 "Preview" 按钮确认截图内容。
3. **添加素材**：在 "Context Materials" 区域，你可以直接输入文本，拖拽文件/图片，或者直接粘贴剪贴板中的截图/文件。也可以点击 "+" 号浏览添加文件。
4. **选择指令**：在 Prompt 下拉框选择任务类型，或直接修改文本框内容。
5. **生成**：点击 "Generate & Fill"，等待 AI 处理并回填数据。
6. **运行宏**：在 "Macro Library" 区域选择或粘贴代码，点击 "Run" 执行自动化脚本。

##  常见问题

- **UI 显示不全？**：插件使用了自适应布局，尝试调整侧边栏宽度。
- **API 报错？**：请检查 API Key 是否过期，以及网络是否能连通 Base URL。
- **宏无法运行？**：
  - 报错信息：`Error executing macro: 不信任到 Visual Basic Project 的程序连接`
  - 解决方法：在 Excel 中，前往 **文件 > 选项 > 信任中心 > 信任中心设置 > 宏设置**，勾选 **信任对 VBA 工程对象模型的访问**。
