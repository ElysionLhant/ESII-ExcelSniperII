# Excel SNIPERII (VSTO 版)

这是一个基于 .NET Framework 4.7.2 开发的 Excel VSTO 加载项（Add-in），深度集成了 LLM（OpenAI、Ollama、LM Studio 等），旨在通过 AI 辅助自动化 Excel 数据处理任务。

## 介绍
说实话，相信大部分坐Office的白领都不会没有被Excel毒害过。这个该死的软件至少能占你的工作时间的30%时间左右。而实际上有意义的工作极少。大多数时候我们都在调整格式，调整字体，调整各种各样的东西。

为了让非结构化的数据结构化还要保持美观给处理Excel的人以外的人方便查看，我们往往要付出内容以上数倍的心血，而那些内容也往往没有任何意义，至少对处理Excel的那个人来说。用于处理这些垃圾文件和格式的心血是这个工具的作者所不拥有，即使有也不愿意浪费给工作的。

**因此，就有了这个插件。Excel Sniper II。**

这个工具的功能，总的来说就是让LLM替你处理那些无意义的复制粘贴，书写公式，修改格式。通过创造一个直观的人机协作的工作流，让LLM处理那些脏活累活。

放心，作者没有让你反复和一个工具内的ChatUI对话半天后复制粘贴然后去下一个窗口继续的意思。**那是Copilot的存在价值，不是这个工具的。**

这个工具允许你自定义并且保存你的Prompt用语数据填充，还能让LLM为你书写定制VBA宏甚至治愈VBA宏，并且将所有你的工作成果保留下来利用在下一次。这样每一次当你使用这个工具的时候，你就在打造属于自己的针对办公事务这个贪婪的吸血鬼的银弹。然后将LLM作为你的武器击毙那些重复的工作。

你可以为不同的功能组件配备不同的LLM使得效果最大化。同时，你可以在自己的本地电脑上运行Ollama,LM Studio等软件来提供LLM服务，这样你还可以剩下微软的Copilot的订阅费用。这让你的数据更加安全。

你可以像操作RTS游戏一样选中一个区域，然后点击执行的自定义操作来让数据变成你想要的样子。

*这个插件的名字的灵感源于作者最喜欢的高达作品中的量产机GM SniperII。*

## 核心功能

### 1. 智能填充与生成 (Image Mode / Data Write)
- **选区捕获**：一键捕获当前 Excel 选区的截图和坐标信息。
  - **预览功能**：捕获后会出现 "Preview" 按钮，支持查看缩略图和完整图片。
- **多模态上下文**：
  - **一体化输入**：整合式输入框，支持文本与文件复合输入。
  - **剪贴板支持**：支持直接粘贴（Ctrl+V）截图或文件。
  - **文件导入**：支持拖拽文本及图片文件，或通过文件浏览器导入。
- **智能回填**：LLM 生成的结构化数据会自动填充回 Excel 表格。
- **智能表头识别**：自动识别表头行数，保护原有格式或提供上下文。
- **参考现有数据开关 (Reference Existing Data)**：
  - **勾选 (默认)**：发送选区的截图和 CSV 数据给 LLM。适用于 **数据清洗** 和 **修正** 任务，模型需要参考旧数据。
  - **不勾选**：仅发送表头结构（不发截图和数据行）。适用于 **全新数据生成**，避免旧脏数据的干扰。

### 2. 数据操作 (Data Op Mode)
- **模式切换**：通过切换开关在 "Data Write" 和 "Data Op" 模式间切换。
- **VBA 自动生成与执行**：
  - 将选中的数据 (CSV) 和用户 Prompt 发送给 LLM。
  - LLM 自动生成处理该数据的 VBA 代码。
  - 插件自动在后台执行生成的 VBA 代码。
  - 适合复杂的数据清洗、格式调整、计算等任务。
- **注意**：在此模式下，“参考现有数据”开关会自动隐藏，因为 Data Op 模式始终需要数据上下文。

### 3. 全面的设置与管理
- **全新设置窗口**：独立的窗口用于管理所有配置。
- **Prompt 管理**：添加、编辑和删除自定义 Prompt 预设。
- **宏 (Macro) 管理**：
  - **本地宏 (Local Macros)**：管理并持久化常用的 VBA 宏代码。
  - **文件内宏 (In-File Macros)**：自动读取当前工作簿中的宏，支持直接运行。
- **高级 LLM 配置**：
  - **简单模式 (Simple Mode)**：使用全局统一的 LLM 配置。
  - **高级模式 (Advanced Mode)**：为不同任务配置不同的 LLM 提供商/模型：
    - **表头勘测 (Header Detection)**：需要 **多模态** 模型 (具备视觉能力)。
    - **数据写入 (Data Write)**：需要 **多模态** 模型 (具备视觉能力)。
    - **数据操作 (Data Op)**：**纯文本** 模型即可 (代码生成)。
    - **VBA 自愈 (VBA Self-healing)**：**纯文本** 模型即可。
  - **本地模型支持**：内置检测本地 **Ollama** 和 **LM Studio** 实例的功能。
  - **多提供商支持**：OpenAI, Ollama, LM Studio。

### 4. 宏代码库与智能自愈
- **一键运行**：无需打开 VBA 编辑器，直接运行选中的宏。
- **智能自愈 (Smart Self-healing)**：
  - 当宏运行报错时，AI 会自动分析错误日志、代码意图以及当前工作簿环境（如 Sheet 名称）。
  - 自动生成修复后的代码并保存为新宏。
  - **注意**：如果因语法错误导致 Excel 强制弹出 VBA 编辑器窗口，请**手动关闭该窗口**，以便插件继续执行 AI 修复流程。
- **持久化存储**：宏代码库保存在本地。

## 技术栈

- **框架**：.NET Framework 4.7.2, VSTO
- **语言**：C#
- **UI**：WPF (现代化 UI)
- **网络**：HttpClient (TLS 1.2)
- **数据**：JSON 序列化存储

## 安装与运行

### 方式一：发布版安装 (推荐普通用户)
1. **下载**：在 GitHub Releases 页面下载最新的 `ExcelSP2_Release.zip` 压缩包。
2. **解压**：将压缩包解压到任意文件夹。
3. **安装**：双击运行 `setup.exe`。
4. **完成**：安装完成后打开 Excel，插件将自动加载。

### 方式二：源码版构建 (推荐开发者)
1. **环境要求**：
   - Windows 操作系统
   - Visual Studio 2019+ (需安装 "Office/SharePoint 开发" 工作负载)
   - Microsoft Excel
2. **打开项目**：
   - 打开 `ExcelSP2.sln`。
3. **编译运行**：
   - 按 F5。Visual Studio 会自动编译并启动 Excel。

### 必读：宏功能配置 (所有用户)
为了让插件能够自动生成和运行 VBA 代码，必须在 Excel 中开启权限：
1. 打开 Excel，点击左上角的 **"文件" (File)**。
2. 选择左下角的 **"选项" (Options)**。
3. 在弹出窗口中，点击左侧的 **"信任中心" (Trust Center)**。
4. 点击右侧的 **"信任中心设置..." (Trust Center Settings...)** 按钮。
5. 在新窗口左侧选择 **"宏设置" (Macro Settings)**。
6. 勾选 **"信任对 VBA 工程对象模型的访问" (Trust access to the VBA project object model)**。
7. 点击确定保存。

## 使用指南

1. **配置设置**：点击 "Settings" 打开配置窗口。
   - 如果运行了 Ollama/LM Studio，可点击 "Detect Local Models"。
   - 选择 "Simple" 或 "Advanced" 模式配置 LLM。
2. **捕获数据**：选中 Excel 数据区域，点击 "Capture"。
3. **选择模式**：
   - **Data Write**：用于填充/清洗单元格。使用 "Reference Existing Data" 复选框控制上下文。
   - **Data Op**：用于通过 VBA 生成进行复杂操作。
4. **添加素材**：拖拽文件或粘贴图片到输入区。
5. **生成**：点击 "Generate & Fill" (或 Data Op 模式下的 "Run")。

## 常见问题

- **API 报错？**：检查设置中的 API Key 和 Base URL。如果使用本地模型，确保服务已启动。
- **宏无法运行？**：请确保已开启 VBA 信任权限。设置路径：**文件 > 选项 > 信任中心 > 信任中心设置 > 宏设置**，勾选 **"信任对 VBA 工程对象模型的访问"**。
- **视觉任务失败？**：确保表头检测和数据写入任务使用的是多模态模型（如 gpt-4o, llava）。
