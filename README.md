# Excel SNIPERII (VSTO Version)

This is an Excel VSTO Add-in based on .NET Framework 4.7.2, deeply integrated with LLMs (OpenAI, Volcengine, etc.), designed to automate Excel data processing tasks through AI assistance.

## Core Features

### 1. Smart Fill & Generation (Image Mode)
- **Selection Capture**: One-click capture of the screenshot and coordinate information of the current Excel selection.
  - **Preview Function**: A "Preview" button appears after capture; hover to view a thumbnail, click to open the full image.
- **Multimodal Context**:
  - **Integrated Input**: A new integrated input box combining text input and file management.
  - **Clipboard Support**: Supports direct pasting (Ctrl+V) of screenshots or copied files, automatically converting them to attachments.
  - **File Import**:
    - **Drag & Drop**: Supports dragging text files (.txt, .csv, .json, .md) and image files directly into the input box.
    - **Manual Browse**: Provides a "+" button to support batch selection of files via file browser.
- **Smart Refill**: Structured data generated by LLM is automatically filled back into the Excel table, supporting automatic row/column expansion.
- **Smart Header Detection & Reuse**:
  - **Initial Generation**: Automatically identifies the number of header rows in the selection, avoiding the header area when generating content to protect original formatting.
  - **Continuous Input**: When performing subsequent operations in the same column range, the plugin reuses the identified header information as context but writes content directly to the currently selected area (without avoiding headers), enabling efficient continuous data entry.
  - **Reset Function**: Provides a reset button to clear cached header information and re-identify headers at any time.

### 2. Prompt Management
- **Preset Library**: Built-in common task Prompts (e.g., Invoice Extraction, Data Cleanup).
- **Custom Management**: Supports saving, loading, and deleting custom Prompts, with persistent configuration.

### 3. Macro Library
- **VBA Management**: Manage common VBA macro codes directly in the sidebar.
- **One-Click Run**: Execute selected macros directly without opening the VBA editor.
- **Persistent Storage**: Macro code library is saved locally and available across workbooks.
- *Note: The Run Macro function requires enabling "Trust access to the VBA project object model" in the Excel Trust Center.*

### 4. Data Mode
- **Mode Switching**: Switch between "Image Mode" and "Data Mode" via the Toggle Switch on the interface.
- **Direct Data Processing**: No screenshot required; directly reads the data of the currently selected Excel cells (CSV format).
- **VBA Auto-Generation & Execution**:
  - Sends the selected data and user Prompt to the LLM.
  - LLM automatically generates VBA code to process the data.
  - The plugin automatically executes the generated VBA code in the background to directly modify the table content.
  - Suitable for complex data cleanup, formatting, calculation, and other tasks.

### 5. System Settings
- **API Configuration**: Supports custom OpenAI-compatible interfaces (Base URL, API Key, Model Name).
- **Persistence**: All settings and presets are saved in the local AppData directory and are not lost when Excel is restarted.

## Tech Stack

- **Framework**: .NET Framework 4.7.2, VSTO (Visual Studio Tools for Office)
- **Language**: C#
- **UI**: WinForms (Using FlowLayoutPanel for adaptive layout)
- **Network**: HttpClient (Supports TLS 1.2)
- **Data**: JSON Serialization Storage

## How to Build & Run

1. **Prerequisites**:
   - Windows OS
   - Visual Studio 2019 or higher (with "Office/SharePoint development" workload installed)
   - Microsoft Excel

2. **Open Project**:
   - Open the `ExcelSP2/ExcelSP2.sln` solution file using Visual Studio.

3. **Build & Run**:
   - Click Start or press F5.
   - Visual Studio will automatically build and start Excel, and the add-in will appear in the sidebar or ribbon.

4. **Macro Function Configuration** (if using Macro Library or Data Mode):
   - In Excel, go to **File > Options > Trust Center > Trust Center Settings > Macro Settings**.
   - Check **Trust access to the VBA project object model**.

## User Guide

1. **Configure API**: Click "Settings" at the bottom of the sidebar for the first time and enter your LLM API information.
2. **Capture Data (Image Mode)**: Select the data area in Excel and click "Capture Selection". After successful capture, verify the screenshot via the "Preview" button.
3. **Add Materials**: In the "Context Materials" area, you can directly enter text, drag files/images, or directly paste screenshots/files from the clipboard. You can also click the "+" sign to browse and add files.
4. **Select Instruction**: Select the task type in the Prompt dropdown box, or directly modify the text box content.
5. **Generate**: Click "Generate & Fill" and wait for AI to process and refill data.
6. **Data Mode**: Toggle the switch to enable Data Mode. Select data, enter a prompt, and click Run. The AI will generate and execute VBA code to manipulate your data.
7. **Run Macro**: Select or paste code in the "Macro Library" area and click "Run" to execute automation scripts.

## FAQ

- **UI not fully displayed?**: The plugin uses adaptive layout; try adjusting the sidebar width.
- **API Error?**: Please check if the API Key has expired and if the network can connect to the Base URL.
- **Macro not running?**: Please ensure that Excel's VBA trust permissions are enabled.
