# Excel SNIPERII (VSTO Version)

This is an Excel VSTO Add-in based on .NET Framework 4.7.2, deeply integrated with LLMs (OpenAI, Ollama, LM Studio, etc.), designed to automate Excel data processing tasks through AI assistance.

## Core Features

### 1. Smart Fill & Generation (Image Mode / Data Write)
- **Selection Capture**: One-click capture of the screenshot and coordinate information of the current Excel selection.
  - **Preview Function**: A "Preview" button appears after capture; hover to view a thumbnail, click to open the full image.
- **Multimodal Context**:
  - **Integrated Input**: A new integrated input box combining text input and file management.
  - **Clipboard Support**: Supports direct pasting (Ctrl+V) of screenshots or copied files, automatically converting them to attachments.
  - **File Import**: Drag & Drop and manual browse support for text and image files.
- **Smart Refill**: Structured data generated by LLM is automatically filled back into the Excel table.
- **Smart Header Detection**: Automatically identifies header rows to protect original formatting or provide context.
- **Reference Existing Data Toggle**:
  - **Checked (Default)**: Sends both the screenshot and CSV data of the selection to the LLM. Ideal for **Data Cleaning** and **Correction** tasks where context is crucial.
  - **Unchecked**: Sends only the header structure (no image, no data rows). Ideal for **Fresh Data Generation** to avoid interference from existing dirty data.

### 2. Data Operation (Data Op Mode)
- **Mode Switching**: Switch between "Data Write" and "Data Op" via the Toggle Switch.
- **VBA Auto-Generation & Execution**:
  - Sends the selected data (CSV) and user Prompt to the LLM.
  - LLM automatically generates VBA code to process the data.
  - The plugin automatically executes the generated VBA code in the background.
  - **Code Review**: After generation, the VBA code is displayed in the Macro Library section for review, allowing you to Save or Discard (Del) it.
  - Suitable for complex data cleanup, formatting, calculation, and other tasks.
- **Note**: The "Reference Existing Data" toggle is automatically hidden in this mode as Data Op always requires data context.

### 3. Comprehensive Settings & Management
- **New Settings Window**: A dedicated window for managing all configurations.
- **Prompt Management**: Add, edit, and delete custom Prompt presets.
- **Macro Management**:
  - **Local Macros**: Manage and persist common VBA macro codes.
  - **In-File Macros**: Automatically read and run macros from the active workbook.
- **Advanced LLM Configuration**:
  - **Simple Mode**: Use a single global LLM configuration for all tasks.
  - **Advanced Mode**: Configure different LLM providers/models for specific tasks:
    - **Header Detection**: Requires a **Multimodal** model (Vision capable).
    - **Data Write**: Requires a **Multimodal** model (Vision capable).
    - **Data Operation**: **Text-only** model is sufficient (Code Generation).
    - **VBA Self-healing**: **Text-only** model is sufficient.
  - **Local Model Support**: Built-in detection for local **Ollama** and **LM Studio** instances.
  - **Provider Support**: OpenAI, Ollama, LM Studio.

### 4. Macro Library & Smart Self-healing
- **Streamlined UI**: The code editor and management buttons (Save/Del) are hidden by default. They automatically appear when a new macro is generated via Data Op mode.
- **One-Click Run**: Execute selected macros directly without opening the VBA editor.
- **Smart Self-healing**:
  - When a macro fails, AI analyzes the error log, code intent, and current workbook context (e.g., Sheet names).
  - Automatically generates fixed code and saves it as a new macro.
  - **Note**: If the VBA Editor window pops up due to a syntax error, please **close it manually** to allow the plugin to proceed with the AI repair process.
- **Persistent Storage**: Macro code library is saved locally.

## Tech Stack

- **Framework**: .NET Framework 4.7.2, VSTO
- **Language**: C#
- **UI**: WPF (Modernized UI)
- **Network**: HttpClient (TLS 1.2)
- **Data**: JSON Serialization

## How to Build & Run

1. **Prerequisites**:
   - Windows OS
   - Visual Studio 2019+ (with "Office/SharePoint development" workload)
   - Microsoft Excel

2. **Open Project**:
   - Open `ExcelSP2/ExcelSP2.sln`.

3. **Build & Run**:
   - Press F5. Visual Studio will build and start Excel.

4. **Macro Configuration**:
   - In Excel: **File > Options > Trust Center > Trust Center Settings > Macro Settings**.
   - Check **Trust access to the VBA project object model**.

## User Guide

1. **Configure Settings**: Click "Settings" to open the configuration window.
   - Use "Detect Local Models" if you have Ollama/LM Studio running.
   - Choose "Simple" or "Advanced" mode to configure your LLM providers.
2. **Capture Data**: Select data in Excel and click "Capture".
3. **Select Mode**:
   - **Data Write**: For filling/cleaning cells. Use the "Reference Existing Data" checkbox to control context.
   - **Data Op**: For complex operations via VBA generation.
4. **Add Context**: Drag files or paste images into the input area.
5. **Generate**: Click "Generate & Fill" (or "Run" in Data Op mode).

## FAQ

- **API Error?**: Check API Key and Base URL in Settings. Ensure local models are running if used.
- **Macro Error?**: Enable "Trust access to the VBA project object model" in Excel.
- **Vision Tasks Failing?**: Ensure you are using a Multimodal model (e.g., gpt-4o, llava) for Header Detection and Data Write.
