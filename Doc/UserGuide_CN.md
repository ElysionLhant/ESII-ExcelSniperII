# Excel Sniper II 用户指南 (User Guide)

## 核心功能详解

### 1. 智能填充与生成 (Image Mode / Data Write)
- **选区捕获**：一键捕获当前 Excel 选区的截图和坐标信息。
  - **预览功能**：捕获后会出现 "Preview" 按钮，支持查看缩略图和完整图片。
- **多模态上下文**：
  - **一体化输入**：整合式输入框，支持文本与文件复合输入。
  - **剪贴板支持**：支持直接粘贴（Ctrl+V）截图或文件。
  - **文件导入**：支持拖拽文本及图片文件，或通过文件浏览器导入。
  - **快速清除**：使用 "🗑" 按钮一键清除所有附件和文本上下文。
- **智能回填**：LLM 生成的结构化数据会自动填充回 Excel 表格。
- **智能表头识别**：自动识别表头行数，保护原有格式或提供上下文。
- **参考现有数据开关 (Reference Existing Data)**：
  - **勾选 (默认)**：发送选区的截图和 CSV 数据给 LLM。适用于 **数据清洗** 和 **修正** 任务，模型需要参考旧数据。
  - **不勾选**：仅发送表头结构（不发截图和数据行）。适用于 **全新数据生成**，避免旧脏数据的干扰。

### 2. 数据操作 (Data Op Mode)
- **模式切换**：通过切换开关在 "Data Write" 和 "Data Op" 模式间切换。
- **VBA 自动生成与执行**：
  - 将选中的数据 (CSV) 和用户 Prompt 发送给 LLM。
  - LLM 自动生成处理该数据的 VBA 代码。
  - 插件自动在后台执行生成的 VBA 代码。
  - **代码审查**：生成后，VBA 代码会显示在宏库区域供审查，你可以保存或丢弃 (Del) 它。
  - 适合复杂的数据清洗、格式调整、计算等任务。
- **注意**：在此模式下，“参考现有数据”开关会自动隐藏，因为 Data Op 模式始终需要数据上下文。

### 3. 全面的设置与管理
- **全新设置窗口**：独立的窗口用于管理所有配置。
- **Prompt 管理**：
  - 添加、编辑和删除自定义 Prompt 预设。
  - 使用 "🗑" 按钮清除当前 Prompt 文本框（不删除预设）。
- **宏 (Macro) 管理**：
  - **本地宏 (Local Macros)**：管理并持久化常用的 VBA 宏代码。
  - **文件内宏 (In-File Macros)**：自动读取当前工作簿中的宏，支持直接运行。
- **高级 LLM 配置**：
  - **简单模式 (Simple Mode)**：使用全局统一的 LLM 配置。
  - **高级模式 (Advanced Mode)**：为不同任务配置不同的 LLM 提供商/模型：
    - **表头勘测 (Header Detection)**：需要 **多模态** 模型 (具备视觉能力)。
    - **数据写入 (Data Write)**：需要 **多模态** 模型 (具备视觉能力)。
    - **数据操作 (Data Op)**：**纯文本** 模型即可 (代码生成)。
    - **VBA 自愈 (VBA Self-healing)**：**纯文本** 模型即可。
  - **本地模型支持**：内置检测本地 **Ollama** 和 **LM Studio** 实例的功能。
  - **多提供商支持**：OpenAI, Ollama, LM Studio。

### 4. 宏代码库与智能自愈
- **精简 UI**：代码编辑器和管理按钮 (Save/Del) 默认隐藏。当通过 Data Op 模式生成新宏时会自动出现。
- **一键运行**：无需打开 VBA 编辑器，直接运行选中的宏。
- **智能自愈 (Smart Self-healing)**：
  - 当宏运行报错时，AI 会自动分析错误日志、代码意图以及当前工作簿环境（如 Sheet 名称）。
  - 自动生成修复后的代码并保存为新宏。
  - **注意**：如果因语法错误导致 Excel 强制弹出 VBA 编辑器窗口，请**手动关闭该窗口**，以便插件继续执行 AI 修复流程。
- **持久化存储**：宏代码库保存在本地。
