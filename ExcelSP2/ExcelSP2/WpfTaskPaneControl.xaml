<UserControl x:Class="ExcelSP2.WpfTaskPaneControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="300"
             Background="WhiteSmoke">
    <UserControl.Resources>
        <Style TargetType="Button">
            <Setter Property="Margin" Value="3"/>
            <Setter Property="Padding" Value="5,2"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="Gray"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>
        <Style TargetType="TextBlock" x:Key="HeaderStyle">
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="3,15,3,5"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>
    </UserControl.Resources>
    
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="10">
            
            <!-- 1. Selection Section -->
            <TextBlock Text="1. Selection" Style="{StaticResource HeaderStyle}"/>
            
            <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                <Button x:Name="btnCapture" Content="Capture" Width="75" Click="BtnCapture_Click"/>
                <Button x:Name="btnPreview" Content="Preview" Width="75" Background="LightGray" Visibility="Collapsed" Click="BtnPreview_Click" MouseEnter="BtnPreview_MouseEnter" MouseLeave="BtnPreview_MouseLeave"/>
                <Button x:Name="btnClearCapture" Content="✕" Width="30" Background="WhiteSmoke" BorderThickness="0" Visibility="Collapsed" Click="BtnClearCapture_Click" ToolTip="Clear Selection"/>
                <Button x:Name="btnResetHeader" Content="Reset" Width="55" Background="LightSalmon" Visibility="Collapsed" Click="BtnResetHeader_Click"/>
            </StackPanel>
            
            <TextBlock x:Name="lblSelectionInfo" Text="No selection captured." Foreground="Gray" TextWrapping="Wrap" Margin="3,5,3,5"/>
            
            <Popup x:Name="previewPopup" PlacementTarget="{Binding ElementName=btnPreview}" Placement="Left" AllowsTransparency="True">
                <Border BorderBrush="DimGray" BorderThickness="1" Background="White" Padding="1">
                    <Image x:Name="previewPopupImage" Width="300" Height="300" Stretch="Uniform"/>
                </Border>
            </Popup>

            <!-- 2. Context Section -->
            <StackPanel Orientation="Horizontal" Margin="0,15,0,0">
                <TextBlock Text="2. Context Materials" FontWeight="Bold" Margin="3,5,3,0"/>
                <Button x:Name="btnAddFile" Content="+" Width="25" Height="23" Margin="10,0,0,0" Click="BtnAddFile_Click"/>
            </StackPanel>

            <Border Background="White" BorderBrush="Gray" BorderThickness="1" Margin="3,5,3,5" Height="120">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Attachments Panel -->
                    <ItemsControl x:Name="itemsAttachments" Grid.Row="0" MaxHeight="45">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="#E6F0FF" Margin="3" Padding="3" CornerRadius="2">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding FileName}" FontSize="10" Margin="0,0,5,0" MaxWidth="100" TextTrimming="CharacterEllipsis"/>
                                        <Button Content="✕" FontSize="10" Padding="0" Background="Transparent" BorderThickness="0" Foreground="Gray" Click="BtnRemoveAttachment_Click" Tag="{Binding FilePath}"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Text Input -->
                    <TextBox x:Name="txtContext" Grid.Row="1" AcceptsReturn="True" BorderThickness="0" Margin="5" VerticalScrollBarVisibility="Auto"
                             PreviewKeyDown="TxtContext_KeyDown" AllowDrop="True" PreviewDragEnter="Context_DragEnter" PreviewDrop="Context_DragDrop"/>
                </Grid>
            </Border>
            <TextBlock Text="Paste images/text or drag files here." Foreground="Gray" FontSize="10" Margin="3,2,3,0"/>

            <!-- 3. Prompt Section -->
            <StackPanel Orientation="Horizontal" Margin="0,15,0,0">
                <TextBlock Text="3. Prompt" FontWeight="Bold" Margin="3,5,10,0"/>
                <ToggleButton x:Name="toggleMode" Width="90" Height="24" Content="Data Write" Checked="ToggleMode_Checked" Unchecked="ToggleMode_Unchecked">
                    <ToggleButton.Style>
                        <Style TargetType="ToggleButton">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border x:Name="border" CornerRadius="12" Background="LightGray" BorderBrush="Gray" BorderThickness="1">
                                            <Grid>
                                                <Ellipse x:Name="knob" Width="20" Height="20" Fill="White" HorizontalAlignment="Left" Margin="2"/>
                                                <TextBlock x:Name="text" Text="Data Write" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,8,0" FontSize="10" FontWeight="Bold"/>
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsChecked" Value="True">
                                                <Setter TargetName="border" Property="Background" Value="Orange"/>
                                                <Setter TargetName="knob" Property="HorizontalAlignment" Value="Right"/>
                                                <Setter TargetName="text" Property="HorizontalAlignment" Value="Left"/>
                                                <Setter TargetName="text" Property="Margin" Value="8,0,0,0"/>
                                                <Setter TargetName="text" Property="Text" Value="Data Op"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ToggleButton.Style>
                </ToggleButton>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                <ComboBox x:Name="cmbPrompts" Width="160" SelectionChanged="CmbPrompts_SelectionChanged" DisplayMemberPath="Title"/>
                <Button x:Name="btnSavePrompt" Content="Save" Width="45" Click="BtnSavePrompt_Click"/>
                <Button x:Name="btnDeletePrompt" Content="Del" Width="40" Click="BtnDeletePrompt_Click"/>
            </StackPanel>
            
            <TextBox x:Name="txtPrompt" Height="80" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,5,0,0"/>

            <!-- 4. Macro Section -->
            <TextBlock Text="4. Macro Library" Style="{StaticResource HeaderStyle}"/>
            
            <StackPanel Orientation="Horizontal">
                <ComboBox x:Name="cmbMacros" Width="120" SelectionChanged="CmbMacros_SelectionChanged" DisplayMemberPath="Title"/>
                <Button x:Name="btnRunMacro" Content="Run" Width="40" Background="LightGreen" Click="BtnRunMacro_Click"/>
                <Button x:Name="btnSaveMacro" Content="Save" Width="40" Click="BtnSaveMacro_Click"/>
                <Button x:Name="btnDeleteMacro" Content="Del" Width="35" Click="BtnDeleteMacro_Click"/>
            </StackPanel>
            
            <TextBox x:Name="txtMacroCode" Height="80" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" FontFamily="Consolas" FontSize="12" Margin="0,5,0,0"/>

            <!-- 5. Settings & Run -->
            <Button x:Name="btnSettings" Content="⚙️ Settings" Width="80" HorizontalAlignment="Left" Margin="3,10,3,3" Click="BtnSettings_Click"/>
            
            <Border x:Name="pnlSettings" Visibility="Collapsed" BorderBrush="Gray" BorderThickness="1" Background="White" Margin="0,5,0,0" Padding="5">
                <StackPanel>
                    <TextBlock Text="API URL:" Margin="0,5,0,0"/>
                    <TextBox x:Name="txtApiUrl" Text="https://api.openai.com/v1" Margin="0,5,0,0"/>
                    
                    <TextBlock Text="API Key:" Margin="0,10,0,0"/>
                    <TextBox x:Name="txtApiKey" Margin="0,5,0,0"/> <!-- PasswordChar not directly supported in TextBox, use PasswordBox or visual trick if needed. For now, plain text or we can use PasswordBox -->
                    
                    <TextBlock Text="Model:" Margin="0,10,0,0"/>
                    <TextBox x:Name="txtModel" Text="gpt-4o" Margin="0,5,0,0"/>
                    
                    <Button Content="Save Settings" Margin="0,15,0,0" Background="WhiteSmoke" Click="BtnSaveSettings_Click"/>
                </StackPanel>
            </Border>

            <Button x:Name="btnRun" Content="Generate &amp; Fill" Height="40" Background="DodgerBlue" Foreground="White" FontWeight="Bold" Margin="3,20,3,3" Click="BtnRun_Click"/>
            <TextBlock x:Name="lblStatus" Text="Ready" Foreground="Blue" TextWrapping="Wrap" Margin="3,5,3,5"/>
            
        </StackPanel>
    </ScrollViewer>
</UserControl>
